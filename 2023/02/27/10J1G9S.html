<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="dark"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png"><link rel="icon" href="/img/fluid.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="inkbox"><meta name="keywords" content=""><meta name="description" content="git-lfs是git对于二进制文件管理的一种扩展，可以减小仓库体积。"><meta property="og:type" content="article"><meta property="og:title" content="自建git-lfs-server"><meta property="og:url" content="http://blog.inkroom.cn/2023/02/27/10J1G9S.html"><meta property="og:site_name" content="墨盒"><meta property="og:description" content="git-lfs是git对于二进制文件管理的一种扩展，可以减小仓库体积。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2023-02-27T00:00:00.000Z"><meta property="article:modified_time" content="2025-07-21T06:55:48.729Z"><meta property="article:author" content="inkbox"><meta property="article:tag" content="git"><meta property="article:tag" content="lfs"><meta property="article:tag" content="cmake"><meta property="article:tag" content="c"><meta name="twitter:card" content="summary_large_image"><title>自建git-lfs-server - 墨盒</title><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"blog.inkroom.cn",root:"/",version:"1.9.8",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"left",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!1,follow_dnt:!0,baidu:null,google:{measurement_id:null},tencent:{sid:null,cid:null},leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1},umami:{src:null,website_id:null,domains:null,start_time:"2024-01-01T00:00:00.000Z",token:null,api_server:null},woyaola:null,cnzz:null},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Fluid</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/" target="_self"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/" target="_self"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/" target="_self"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/" target="_self"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/" target="_self"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" data-typed-text="自建git-lfs-server"></span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-02-27 00:00" pubdate>2023年2月27日 凌晨</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.4k 字</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="padding-left:2rem;margin-right:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">自建git-lfs-server</h1><div class="markdown-body"><p>git-lfs是git对于二进制文件管理的一种扩展，可以减小仓库体积。</p><span id="more"></span><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>我的<a target="_blank" rel="noopener" href="https://github.com/inkroom/image">图片库</a>由于存放了大量的图片，发现仓库本身高达<strong>5G</strong>，其中 <strong>.git</strong> 目录就占了一半，应该是每一个二进制文件就会有个备份，再加上被删除的文件。</p><p>尝试过重建commit历史，但是依然没减小。</p><p>后来了解到<a target="_blank" rel="noopener" href="https://github.com/git-lfs/git-lfs">git-lfs</a>，github的lfs仓库就给<strong>1G</strong>，等于没有，于是准备自建一个。</p><p>由于个人的兴趣爱好原因，准备使用<strong>C</strong>来实现</p><h2 id="项目搭建"><a href="#项目搭建" class="headerlink" title="项目搭建"></a>项目搭建</h2><p>经过一通搜索，找到了一个C的web框架<a target="_blank" rel="noopener" href="https://facil.io">facil.io</a>，正常情况下，应该没什么人会用纯C写web，起码也要用C++，所以能找到一个框架真不容易</p><p>C的编译可以命令行，本次选择使用<strong>CMake</strong>。</p><p>开发软件使用<a target="_blank" rel="noopener" href="https://code.visualstudio.com/">VSCode</a></p><p>开发环境搭建使用之前搞出来的<a target="_blank" rel="noopener" href="https://gist.github.com/inkroom/501548078a930c6f3bd98ea257409648">docker镜像</a>，再用VSCode远程开发</p><p>由于我对CMake完全不熟悉，所以用了一个<a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=ChenPerach.c-cpp-cmake-project-creator">插件</a>来新建项目。</p><hr><p>插件本身只是创建基础的目录结构，启动脚本之类的。源代码初始化需要使用<strong>facil</strong>提供的<a target="_blank" rel="noopener" href="https://github.com/boazsegev/facil.io">脚本</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">bash &lt;(curl -s https://raw.githubusercontent.com/boazsegev/facil.io/master/scripts/new/app) appname<br></code></pre></td></tr></table></figure><p>上面的两个步骤需要两个单独的文件夹，之后把脚本创建的目录里的 <strong>.c</strong> 和 <strong>.h</strong> 复制到插件目录里。</p><p>为了引入<strong>facil</strong>依赖，将其源码作为git子模块引入</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">git submodule add https://github.com/boazsegev/facil.io<br></code></pre></td></tr></table></figure><p>最后目录结构如下</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus">. <br>├── CMakeLists<span class="hljs-selector-class">.txt</span> <br>├── LICENSE<br>├── README<span class="hljs-selector-class">.md</span><br>├── facil<span class="hljs-selector-class">.io</span><br>├── include<br>│   ├── cli<span class="hljs-selector-class">.h</span><br>│   ├── http_service<span class="hljs-selector-class">.h</span><br>│   └── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.h</span><br>└── <span class="hljs-attribute">src</span><br>    ├── cli<span class="hljs-selector-class">.c</span><br>    ├── http_service<span class="hljs-selector-class">.c</span><br>    └── <span class="hljs-selector-tag">main</span>.c<br></code></pre></td></tr></table></figure><h2 id="协议文档"><a href="#协议文档" class="headerlink" title="协议文档"></a>协议文档</h2><p>本次要实现一个最简单的lfs服务器，相关文档可以查看<a target="_blank" rel="noopener" href="https://github.com/git-lfs/git-lfs/tree/main/docs/api">lfs仓库</a></p><h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><p>facil是个基础的web框架，没有路由功能，不过没有正好，本来也不需要那些功能。</p><p>这里只需要实现一个 <strong>Batch</strong> 接口，只需要以下代码就能判断url</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">on_http_request</span><span class="hljs-params">(http_s *h)</span><br>&#123;<br>  <span class="hljs-comment">/* set a response and send it (finnish vs. destroy). */</span><br><br>  fio_str_info_s path = fiobj_obj2cstr(h-&gt;path);<br><br>  fio_str_info_s method = fiobj_obj2cstr(h-&gt;method);<br><br>  fio_str_info_s body = fiobj_obj2cstr(h-&gt;body);<br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(path.data, LFS_BATCH_URL_PATH) == <span class="hljs-number">0</span>)<br>  &#123;<br>    batch_request(h);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>LFS_BATCH_URL_PATH</code>是一个字符串宏，具体内容是：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> LFS_BATCH_URL_PATH <span class="hljs-string">&quot;/objects/batch&quot;</span></span><br></code></pre></td></tr></table></figure><p>c语言作为早期的高级语言，功能比较原始。比如字符串是用字符数组——实际上很多更高级的语言也是这样——实现的，所以很多库都需要自己用结构体来定义字符串，上面的<code>fio_str_info_s</code>是<strong>facil</strong>定义的，之后还有别的库定义的字符串</p><h2 id="逻辑"><a href="#逻辑" class="headerlink" title="逻辑"></a>逻辑</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-type">void</span> _batch_request(http_s *h, FIOBJ jsonBody, lfs_item_each each)<br>&#123;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;request 1\n&quot;</span>);<br>    FIOBJ objectsKey = fiobj_str_new(<span class="hljs-string">&quot;objects&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;objects&quot;</span>));<br>    FIOBJ objects = fiobj_hash_get(jsonBody, objectsKey);<br><br>    <span class="hljs-keyword">if</span> (!fiobj_type_is(objects, FIOBJ_T_ARRAY))<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;not allowed json body &quot;</span>);<br><br>        fio_free(objects);<br>        fio_free(objectsKey);<br><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;request 2\n&quot;</span>);<br><br>    <span class="hljs-comment">// 构建要返回的数据结构</span><br>    FIOBJ res = fiobj_hash_new2(<span class="hljs-number">3</span>);<br>    FIOBJ transferKey = fiobj_str_new(<span class="hljs-string">&quot;transfer&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;transfer&quot;</span>));<br>    FIOBJ basic = fiobj_str_new(<span class="hljs-string">&quot;basic&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;basic&quot;</span>));<br><br>    FIOBJ hash_algo_key = fiobj_str_new(<span class="hljs-string">&quot;hash_algo&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;hash_algo&quot;</span>));<br>    FIOBJ sha256 = fiobj_str_new(<span class="hljs-string">&quot;sha256&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;sha256&quot;</span>));<br>    fiobj_hash_set(res, transferKey, basic);<br>    fiobj_hash_set(res, hash_algo_key, sha256);<br><br>    <span class="hljs-type">size_t</span> count = fiobj_ary_count(objects);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;request 3&quot;</span>);<br><br>    <span class="hljs-comment">// FIOBJ authenticated = fiobj_str_new(&quot;true&quot;, strlen(&quot;true&quot;));</span><br><br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; count; i++)<br>    &#123;<br>        FIOBJ item = fiobj_ary_index(objects, i);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;request 4\n&quot;</span>);<br><br>        each(item);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;request 5\n&quot;</span>);<br><br>        <span class="hljs-comment">// fio_free(item);</span><br>    &#125;<br><br>    fiobj_hash_set(res, objectsKey, objects);<br>    FIOBJ f = fiobj_obj2json(res, <span class="hljs-number">1</span>);<br>    fio_str_info_s res_str = fiobj_obj2cstr(f);<br>    fiobj_free(f);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;res %s\n&quot;</span>, res_str.data);<br>    FIOBJ contentTypeKey = fiobj_str_new(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;Content-Type&quot;</span>));<br>    FIOBJ contentType = fiobj_str_new(<span class="hljs-string">&quot;application/vnd.git-lfs+json&quot;</span>, <span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;application/vnd.git-lfs+json&quot;</span>));<br>    <span class="hljs-type">int</span> r = http_set_header(h, contentTypeKey, contentType);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;set content type %d\n&quot;</span>, r);<br>    http_send_body(h, res_str.data, res_str.len);<br><br>    fiobj_free(objects);<br>    fiobj_free(objectsKey);<br><br>    fiobj_free(contentTypeKey);<br>    fiobj_free(contentType);<br><br>    fiobj_free(hash_algo_key);<br>    fiobj_free(sha256);<br><br>    fiobj_free(transferKey);<br>    fiobj_free(basic);<br><br>    fiobj_free(res);<br><br>    <span class="hljs-comment">// fio_free(oidKey);</span><br>    <span class="hljs-comment">// fio_free(sizeKey);</span><br>    <span class="hljs-comment">// fio_free(objects);</span><br>    <span class="hljs-comment">// fio_free(objectsKey);</span><br>&#125;<br></code></pre></td></tr></table></figure><hr><p><code>lfs_item_each</code>是一个函数指针，upload和download有不同的实现，由于逻辑本身很简单，不再贴代码了，要看可以直接去<a target="_blank" rel="noopener" href="https://github.com/inkroom/git-lfs-server-c">仓库</a></p><h2 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h2><p><strong>git-lfs</strong>本身不负责存储，只是负责提供存储相关的API。本次采用<a target="_blank" rel="noopener" href="https://github.com/tencentyun/cos-c-sdk-v5">腾讯云COS</a>作为存储</p><p>需要调用两个核心方法<strong>cos_gen_presigned_url</strong>和<strong>cos_gen_object_url</strong>；一个是上传用url，一个是下载用url。</p><p>COS库本身的编译安装这里略过不提</p><p>由于引入了第三方库，所以需要修改<strong>CMakeLists.txt</strong>，参考cos提供的demo里的，直接把内容拷贝过来，最后就是这样</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><code class="hljs CMake"><span class="hljs-keyword">cmake_minimum_required</span>(VERSION <span class="hljs-number">3.14</span>)<br><br><br><span class="hljs-keyword">set</span>(PROJECT_N lfs)<br><span class="hljs-keyword">project</span>(<span class="hljs-variable">$&#123;PROJECT_N&#125;</span> VERSION <span class="hljs-number">1.0</span>)<br><br><span class="hljs-keyword">set</span>(CMAKE_C_STANDARD <span class="hljs-number">99</span>)<br><span class="hljs-keyword">set</span>(CMAKE_C_STANDARD_REQUIRED <span class="hljs-keyword">True</span>)<br><span class="hljs-keyword">set</span>(CMAKE_EXPORT_COMPILE_COMMANDS <span class="hljs-keyword">ON</span>) <span class="hljs-comment"># 最好只在debug下生成这个，或者 -DCMAKE_EXPORT_COMPILE_COMMANDS=on</span><br><br><span class="hljs-comment"># if (WIN32 OR MSVC)</span><br><span class="hljs-comment">#     set(CMAKE_FIND_LIBRARY_SUFFIXES &quot;.lib&quot;)</span><br><span class="hljs-comment"># elseif (UNIX)</span><br><span class="hljs-comment">#     # 仅查找静态库，强制后缀为 .a</span><br><span class="hljs-comment">#     set(CMAKE_FIND_LIBRARY_SUFFIXES &quot;.a&quot;)</span><br><br><span class="hljs-comment">#     # 如果只是优先查找静态库，保证 .a 后缀在前面即可，把默认的后缀加上</span><br><span class="hljs-comment">#     # set(CMAKE_FIND_LIBRARY_SUFFIXES .a $&#123;CMAKE_FIND_LIBRARY_SUFFIXES&#125;)</span><br><span class="hljs-comment"># endif()</span><br><br><br><span class="hljs-keyword">file</span>(GLOB_RECURSE SRCS <span class="hljs-variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/src/*.c)<br><br><span class="hljs-comment"># a macro that gets all of the header containing directories. </span><br><span class="hljs-keyword">MACRO</span>(header_directories return_list includes_base_folder extention)<br>    <span class="hljs-keyword">FILE</span>(GLOB_RECURSE new_list <span class="hljs-variable">$&#123;includes_base_folder&#125;</span>/*.<span class="hljs-variable">$&#123;extention&#125;</span>)<br>    <span class="hljs-keyword">SET</span>(dir_list <span class="hljs-string">&quot;&quot;</span>)<br>    <span class="hljs-keyword">FOREACH</span>(file_path <span class="hljs-variable">$&#123;new_list&#125;</span>)<br>        <span class="hljs-keyword">GET_FILENAME_COMPONENT</span>(dir_path <span class="hljs-variable">$&#123;file_path&#125;</span> PATH)<br>        <span class="hljs-keyword">SET</span>(dir_list <span class="hljs-variable">$&#123;dir_list&#125;</span> <span class="hljs-variable">$&#123;dir_path&#125;</span>)<br>    <span class="hljs-keyword">ENDFOREACH</span>()<br>    <span class="hljs-keyword">LIST</span>(REMOVE_DUPLICATES dir_list)<br>    <span class="hljs-keyword">SET</span>(<span class="hljs-variable">$&#123;return_list&#125;</span> <span class="hljs-variable">$&#123;dir_list&#125;</span>)<br><span class="hljs-keyword">ENDMACRO</span>()<br><span class="hljs-comment"># a macro that gets all of the header containing directories.</span><br>header_directories(INCLUDES <span class="hljs-variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/<span class="hljs-keyword">include</span>/ h)<br><br><span class="hljs-comment"># include(FetchContent)</span><br><span class="hljs-comment"># FetchContent_Declare(curl</span><br><span class="hljs-comment">#         GIT_REPOSITORY https://github.com/curl/curl.git</span><br><span class="hljs-comment">#         GIT_TAG 7.88.1)</span><br><span class="hljs-comment"># FetchContent_MakeAvailable(curl)</span><br><br><span class="hljs-comment"># add_subdirectory(cos-c-sdk-v5)</span><br><br><br><span class="hljs-comment"># find_package(libcos_c_sdk)</span><br><br><br><br><span class="hljs-keyword">FIND_PROGRAM</span>(APR_CONFIG_BIN NAMES apr-config apr-<span class="hljs-number">1</span>-config PATHS /usr/bin /usr/local/bin /usr/local/apr/bin/)<br><span class="hljs-keyword">FIND_PROGRAM</span>(APU_CONFIG_BIN NAMES apu-config apu-<span class="hljs-number">1</span>-config PATHS /usr/bin /usr/local/bin /usr/local/apr/bin/)<br><br><span class="hljs-keyword">IF</span> (APR_CONFIG_BIN)<br>    <span class="hljs-keyword">EXECUTE_PROCESS</span>(<br>        <span class="hljs-keyword">COMMAND</span> <span class="hljs-variable">$&#123;APR_CONFIG_BIN&#125;</span> --includedir<br>        OUTPUT_VARIABLE APR_INCLUDE_DIR<br>        OUTPUT_STRIP_TRAILING_WHITESPACE<br>    )<br>    <span class="hljs-keyword">EXECUTE_PROCESS</span>(<br>        <span class="hljs-keyword">COMMAND</span> <span class="hljs-variable">$&#123;APR_CONFIG_BIN&#125;</span> --cflags<br>        OUTPUT_VARIABLE APR_C_FLAGS<br>        OUTPUT_STRIP_TRAILING_WHITESPACE<br>    )<br>    <span class="hljs-keyword">EXECUTE_PROCESS</span>(<br>        <span class="hljs-keyword">COMMAND</span> <span class="hljs-variable">$&#123;APR_CONFIG_BIN&#125;</span> --link-ld<br>        OUTPUT_VARIABLE APR_LIBRARIES<br>        OUTPUT_STRIP_TRAILING_WHITESPACE<br>    )<br><span class="hljs-keyword">ELSE</span>()<br>    <span class="hljs-keyword">MESSAGE</span>(FATAL_ERROR <span class="hljs-string">&quot;Could not find apr-config/apr-1-config&quot;</span>)<br><span class="hljs-keyword">ENDIF</span>()<br><br><span class="hljs-keyword">IF</span> (APU_CONFIG_BIN)<br>    <span class="hljs-keyword">EXECUTE_PROCESS</span>(<br>        <span class="hljs-keyword">COMMAND</span> <span class="hljs-variable">$&#123;APU_CONFIG_BIN&#125;</span> --includedir<br>        OUTPUT_VARIABLE APR_UTIL_INCLUDE_DIR<br>        OUTPUT_STRIP_TRAILING_WHITESPACE<br>    )<br>    <span class="hljs-keyword">EXECUTE_PROCESS</span>(<br>        <span class="hljs-keyword">COMMAND</span> <span class="hljs-variable">$&#123;APU_CONFIG_BIN&#125;</span> --cflags<br>        OUTPUT_VARIABLE APU_C_FLAGS<br>        OUTPUT_STRIP_TRAILING_WHITESPACE<br>    )<br>    <span class="hljs-keyword">EXECUTE_PROCESS</span>(<br>        <span class="hljs-keyword">COMMAND</span> <span class="hljs-variable">$&#123;APU_CONFIG_BIN&#125;</span> --link-ld<br>        OUTPUT_VARIABLE APU_LIBRARIES<br>        OUTPUT_STRIP_TRAILING_WHITESPACE<br>    )<br><span class="hljs-keyword">ELSE</span>()<br>    <span class="hljs-keyword">MESSAGE</span>(FATAL_ERROR <span class="hljs-string">&quot;Could not find apu-config/apu-1-config&quot;</span>)<br><span class="hljs-keyword">ENDIF</span>()<br><br><span class="hljs-comment">#curl-config</span><br><span class="hljs-keyword">FIND_PROGRAM</span>(CURL_CONFIG_BIN NAMES curl-config)<br>  <br><span class="hljs-keyword">IF</span> (CURL_CONFIG_BIN)<br>    <span class="hljs-keyword">EXECUTE_PROCESS</span>(<br>        <span class="hljs-keyword">COMMAND</span> <span class="hljs-variable">$&#123;CURL_CONFIG_BIN&#125;</span> --libs<br>        OUTPUT_VARIABLE CURL_LIBRARIES<br>        OUTPUT_STRIP_TRAILING_WHITESPACE<br>        )<br><span class="hljs-keyword">ELSE</span>()<br>    <span class="hljs-keyword">MESSAGE</span>(FATAL_ERROR <span class="hljs-string">&quot;Could not find curl-config&quot;</span>)<br><span class="hljs-keyword">ENDIF</span>()<br><span class="hljs-comment"># set(CURL_LIBRARY &quot;-lcurl&quot;) </span><br><span class="hljs-comment"># find_package(CURL REQUIRED) </span><br><br><span class="hljs-keyword">include_directories</span> (<span class="hljs-variable">$&#123;APR_INCLUDE_DIR&#125;</span>)<br><span class="hljs-keyword">include_directories</span> (<span class="hljs-variable">$&#123;APR_UTIL_INCLUDE_DIR&#125;</span>)<br><span class="hljs-keyword">include_directories</span> (<span class="hljs-variable">$&#123;MINIXML_INCLUDE_DIR&#125;</span>)<br><span class="hljs-keyword">include_directories</span> (<span class="hljs-variable">$&#123;CURL_INCLUDE_DIR&#125;</span>)<br><span class="hljs-comment"># include_directories(&quot;include/curl&quot;)</span><br><span class="hljs-comment"># message(&quot;url $&#123;CURL_INCLUDE_DIRS&#125;&quot;)</span><br><span class="hljs-keyword">include_directories</span> (<span class="hljs-string">&quot;/usr/local/include/cos_c_sdk&quot;</span>)<br><br><span class="hljs-keyword">find_library</span>(APR_LIBRARY apr-<span class="hljs-number">1</span> PATHS /usr/local/apr/lib/)<br><span class="hljs-keyword">find_library</span>(APR_UTIL_LIBRARY aprutil-<span class="hljs-number">1</span> PATHS /usr/local/apr/lib/)<br><span class="hljs-keyword">find_library</span>(MINIXML_LIBRARY mxml)<br><span class="hljs-keyword">find_library</span>(CURL_LIBRARY curl)<br><span class="hljs-keyword">find_library</span>(COS_LIBRARY cos_c_sdk PATHS /usr/local/lib/)<br><br><span class="hljs-keyword">add_subdirectory</span>(facil.io)<br><span class="hljs-keyword">message</span>(STATUS <span class="hljs-variable">$&#123;SRCS&#125;</span>)<br><span class="hljs-keyword">add_executable</span>(<span class="hljs-variable">$&#123;PROJECT_N&#125;</span> <span class="hljs-variable">$&#123;SRCS&#125;</span>)<br><br><span class="hljs-keyword">target_include_directories</span>(<span class="hljs-variable">$&#123;PROJECT_N&#125;</span> PUBLIC <span class="hljs-keyword">include</span> )<br><span class="hljs-keyword">target_link_libraries</span>(<span class="hljs-variable">$&#123;PROJECT_N&#125;</span> facil.io)<br><span class="hljs-comment"># target_link_libraries($&#123;PROJECT_N&#125; PRIVATE  cos_c_sdk::cos_c_sdk)</span><br><span class="hljs-keyword">target_link_libraries</span>(<span class="hljs-variable">$&#123;PROJECT_N&#125;</span> <span class="hljs-variable">$&#123;COS_LIBRARY&#125;</span>)<br><span class="hljs-keyword">target_link_libraries</span>(<span class="hljs-variable">$&#123;PROJECT_N&#125;</span> <span class="hljs-variable">$&#123;APR_UTIL_LIBRARY&#125;</span>)<br><span class="hljs-keyword">target_link_libraries</span>(<span class="hljs-variable">$&#123;PROJECT_N&#125;</span> <span class="hljs-variable">$&#123;APR_LIBRARY&#125;</span>)<br><span class="hljs-keyword">target_link_libraries</span>(<span class="hljs-variable">$&#123;PROJECT_N&#125;</span> <span class="hljs-variable">$&#123;MINIXML_LIBRARY&#125;</span>)<br><br><span class="hljs-comment"># target_link_libraries($&#123;PROJECT_N&#125; curl)</span><br><span class="hljs-keyword">target_link_libraries</span>(<span class="hljs-variable">$&#123;PROJECT_N&#125;</span> <span class="hljs-variable">$&#123;CURL_LIBRARY&#125;</span>)<br><br></code></pre></td></tr></table></figure><h2 id="docker镜像"><a href="#docker镜像" class="headerlink" title="docker镜像"></a>docker镜像</h2><p>C程序过于依赖环境，所以最好使用docker镜像来运行构建产物。</p><p>采用docker<strong>多阶段构建</strong>，对docker版本要求较高，公司的测试服务器版本就很低，不支持该特性</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs Dockerfile"><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">20.04</span><br><span class="hljs-keyword">ENV</span> TZ=Asia/Shanghai<br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">ln</span> -snf /usr/share/zoneinfo/<span class="hljs-variable">$TZ</span> /etc/localtime &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-variable">$TZ</span> &gt; /etc/timezone &amp;&amp; <span class="hljs-built_in">export</span> DEBIAN_FRONTEND=noninteractive</span><br><span class="hljs-comment"># libapr1-dev</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> sed -i <span class="hljs-string">&quot;s@http://.*archive.ubuntu.com@http://mirrors.huaweicloud.com@g&quot;</span> /etc/apt/sources.list \</span><br><span class="language-bash">    &amp;&amp; sed -i <span class="hljs-string">&quot;s@http://.*security.ubuntu.com@http://mirrors.huaweicloud.com@g&quot;</span> /etc/apt/sources.list \</span><br><span class="language-bash">    &amp;&amp; apt update -y &amp;&amp; apt upgrade -y</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt install -y cmake g++  libaprutil1-dev libcurl4-openssl-dev curl wget git libssl-dev</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> wget https://github.com/michaelrsweet/mxml/releases/download/v3.3.1/mxml-3.3.1.tar.gz \</span><br><span class="language-bash">    &amp;&amp; tar -zxf mxml-3.3.1.tar.gz &amp;&amp; <span class="hljs-built_in">cd</span> mxml-3.3.1 &amp;&amp; ./configure  &amp;&amp; make &amp;&amp; make install</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> wget https://dlcdn.apache.org/apr/apr-1.7.2.tar.gz \</span><br><span class="language-bash">    &amp;&amp; tar -zxf apr-1.7.2.tar.gz &amp;&amp; <span class="hljs-built_in">cd</span> apr-1.7.2 &amp;&amp; ./configure  &amp;&amp; make &amp;&amp; make install</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> wget https://github.com/tencentyun/cos-c-sdk-v5/archive/refs/tags/v5.0.16.tar.gz \</span><br><span class="language-bash">    &amp;&amp; tar -zxf v5.0.16.tar.gz &amp;&amp; <span class="hljs-built_in">cd</span> cos-c-sdk-v5-5.0.16 &amp;&amp; cmake .  &amp;&amp; make &amp;&amp; make install</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> wget https://curl.se/download/curl-7.88.1.tar.gz</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt install -y libssl-dev</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> tar -zxf curl-7.88.1.tar.gz &amp;&amp; <span class="hljs-built_in">cd</span> curl-7.88.1/ &amp;&amp; ./configure --disable-ldap --disable-ldaps --with-openssl &amp;&amp; make &amp;&amp; make install</span><br><br><span class="hljs-keyword">ADD</span><span class="language-bash"> . /data</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">cd</span> /data &amp;&amp; git submodule update --init --recursive &amp;&amp; <span class="hljs-built_in">mkdir</span> /data/build &amp;&amp; <span class="hljs-built_in">cd</span> /data/build &amp;&amp; cmake .. &amp;&amp; make &amp;&amp; <span class="hljs-built_in">chmod</span> +x lfs &amp;&amp; <span class="hljs-built_in">cp</span> ../entrypoint.sh ./ &amp;&amp; <span class="hljs-built_in">chmod</span> +x entrypoint.sh  &amp;&amp; <span class="hljs-built_in">cp</span> ../pack.sh ./  &amp;&amp; <span class="hljs-built_in">mkdir</span> lib &amp;&amp; sh pack.sh  </span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> </span><br><br><br><br><br><br><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">20.04</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> --from=0  /data/build/ /lfs</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">3000</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="hljs-string">&quot;/lfs/entrypoint.sh&quot;</span>]</span><br></code></pre></td></tr></table></figure><hr><p>有几点需要注意，现在都是动态编译的，单个文件无法运行，需要一堆.so动态库，所以需要使用<code>pack.sh</code>来拷贝依赖，<code>entrypoint.sh</code>来运行程序</p><p><strong>pack.sh</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">exe=&quot;lfs&quot; # 这里是最终构建的可执行程序的名字<br>des=&quot;$(pwd)/lib&quot;<br>echo $des<br>deplist=$(ldd $exe | awk &#x27;&#123;if (match($3,&quot;/&quot;))&#123; printf(&quot;%s &quot;),$3 &#125; &#125;&#x27;)<br>cp $deplist $des<br></code></pre></td></tr></table></figure><p><strong>entrypoint.sh</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span><br>dirname=`dirname $0`<br>tmp=&quot;$&#123;dirname#?&#125;&quot;<br>if [ &quot;$&#123;dirname%$tmp&#125;&quot; != &quot;/&quot; ]; then<br>dirname=$PWD/$dirname<br>fi<br>LD_LIBRARY_PATH=$dirname/lib<br>export LD_LIBRARY_PATH<br>echo $LD_LIBRARY_PATH<br><span class="hljs-meta prompt_">$</span><span class="language-bash"><span class="hljs-built_in">dirname</span>/lfs <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span></span><br></code></pre></td></tr></table></figure><p>基础原理就是告诉Linux系统去哪里找对应的动态库文件。</p><p>但是上面拷贝的动态库实际上是不全的，缺少<strong>glibc</strong>，这一部分一般由操作系统提供，所以最终使用的运行镜像是<strong>Ubuntu:20.04</strong>，不能使用诸如<strong>alpine</strong>、<strong>busybox</strong>之类的精简镜像，因为没有匹配的环境</p><h2 id="静态编译"><a href="#静态编译" class="headerlink" title="静态编译"></a>静态编译</h2><p>由于动态库下最终镜像体积高达<strong>87MB</strong>，实在是太大了，所以尝试使用静态编译，然后更新精简镜像来缩小体积</p><p>想要实现动态编译，就要告诉CMake去查找 <strong>.a</strong> 文件，可以添加以下代码</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs CMake"><span class="hljs-keyword">if</span> (WIN32 <span class="hljs-keyword">OR</span> MSVC)<br>    <span class="hljs-keyword">set</span>(CMAKE_FIND_LIBRARY_SUFFIXES <span class="hljs-string">&quot;.lib&quot;</span>)<br><span class="hljs-keyword">elseif</span> (UNIX)<br>    <span class="hljs-comment"># 仅查找静态库，强制后缀为 .a</span><br>    <span class="hljs-keyword">set</span>(CMAKE_FIND_LIBRARY_SUFFIXES <span class="hljs-string">&quot;.a&quot;</span>)<br><br><span class="hljs-comment">#     # 如果只是优先查找静态库，保证 .a 后缀在前面即可，把默认的后缀加上</span><br><span class="hljs-comment">#     # set(CMAKE_FIND_LIBRARY_SUFFIXES .a $&#123;CMAKE_FIND_LIBRARY_SUFFIXES&#125;)</span><br><span class="hljs-keyword">endif</span>()<br><br></code></pre></td></tr></table></figure><p>注意 cos 库的 .a 文件名与常规命名规则不同，修改一下</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CMake"><span class="hljs-keyword">find_library</span>(COS_LIBRARY libcos_c_sdk_static.a PATHS /usr/local/lib/)<br></code></pre></td></tr></table></figure><hr><p>由于我不知道的原因，静态编译需要把动态编译下不需要关心的依赖的依赖也给加进来，这里主要是 <strong>liburl</strong> 的一些依赖</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs CMake"><br><span class="hljs-keyword">find_library</span>(IDN_LIBRARY idn)<br><span class="hljs-keyword">find_library</span>(SSL_LIBRARY ssl)<br><span class="hljs-keyword">find_library</span>(C_LIBRARY crypto)<br><span class="hljs-keyword">find_library</span>(DL_LIBRARY dl)<br><br><br><span class="hljs-keyword">target_link_libraries</span>(<span class="hljs-variable">$&#123;LIBRARY_N&#125;</span> <span class="hljs-variable">$&#123;IDN_LIBRARY&#125;</span> <span class="hljs-variable">$&#123;SSL_LIBRARY&#125;</span> <span class="hljs-variable">$&#123;C_LIBRARY&#125;</span> <span class="hljs-variable">$&#123;DL_LIBRARY&#125;</span> <span class="hljs-variable">$&#123;THREAD_LIBRARY&#125;</span>)<br><br></code></pre></td></tr></table></figure><p>Docker镜像可以使用<strong>busybox</strong>，我还调整curl编译参数，去掉一些不需要的功能。最终产物就只有<strong>12.1MB</strong>了，比较完美</p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>可以使用github actions来构建docker镜像，并发布到github packages，这里不再赘述</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="noopener" href="https://github.com/git-lfs/git-lfs">git-lfs</a></li><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/511750788">自行构建GIT LFS服务</a></li><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/437865866">https://zhuanlan.zhihu.com/p/437865866</a></li></ul></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%90%8E%E7%AB%AF/" class="category-chain-item">后端</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/git/" class="print-no-link">#git</a> <a href="/tags/lfs/" class="print-no-link">#lfs</a> <a href="/tags/cmake/" class="print-no-link">#cmake</a> <a href="/tags/c/" class="print-no-link">#c</a></div></div><div class="license-box my-3"><div class="license-title"><div>自建git-lfs-server</div><div>http://blog.inkroom.cn/2023/02/27/10J1G9S.html</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>inkbox</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年2月27日</div></div><div class="license-meta-item"><div>许可协议</div><div><a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-cc-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/07/24/3GFZG3W.html" title="Github Action并行构建多架构docker"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Github Action并行构建多架构docker</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/02/17/X0B93.html" title="使用github actions更新存储库"><span class="hidden-mobile">使用github actions更新存储库</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div></div></footer><script src="https://cdn.bootcdn.net/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/typed.js/2.0.12/typed.min.js"></script><script>!function(t,e){var i=Fluid.plugins.typing,n=e.getElementById("subtitle");n&&i&&i(n.getAttribute("data-typed-text"))}(window,document)</script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://cdn.bootcdn.net/ajax/libs/tocbot/4.20.1/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var o=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-o},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://cdn.bootcdn.net/ajax/libs/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>